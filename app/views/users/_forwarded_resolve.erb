<% if complaints.any? %>
  <% complaints.each do |complaint| %>
    <div style="border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 25px; background: #f9f9f9;">

      <!-- Header -->
      <h3 style="margin-top: 0;">ðŸ“„ Complaint #<%= complaint.id %></h3>
      <p><strong>Category:</strong> <%= complaint.category_type %></p>

      <!-- Involved Users -->
      <div style="margin-top: 10px;">
        <strong>Involved Users:</strong>
        <ul style="margin-left: 20px;">
          <% complaint.user_complaints.includes(:user).each do |uc| %>
            <li>
              <%= uc.user&.email || "User ##{uc.user_id}" %> â€” <%= uc.role.humanize %>
            </li>
          <% end %>
        </ul>
      </div>

      <!-- Show and Resolve Buttons -->
      <div style="margin: 15px 0;">
        <%= link_to 'View Full Complaint', complaint_path(complaint),
                    style: 'display: inline-block; padding: 6px 12px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin-right: 10px;' %>

        <%= button_to 'âœ… Resolve', resolve_complaint_path(complaint),
                      method: :patch,
                      style: 'display: inline-block; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 5px;' %>
      </div>

      <!-- Comments Section -->
      <div style="margin-top: 15px;">
        <strong>ðŸ’¬ Comments:</strong>
        <% if complaint.complain_messages.any? %>
          <ul style="margin-left: 20px;">
            <% complaint.complain_messages.includes(:user).each do |msg| %>
              <li style="margin-bottom: 5px;">
                <strong><%= msg.user&.email || "User ##{msg.user_id}" %>:</strong>
                <%= msg.content %>
                <% if current_user.id == msg.user_id || current_user.admin? %>
                  <%= link_to 'Delete', "/messages/#{msg.id}", method: :delete,
                              data: { confirm: 'Delete this comment?' },
                              style: 'margin-left: 10px; color: red;' %>
                <% end %>
              </li>
            <% end %>
          </ul>
        <% else %>
          <p style="color: #777;">No comments yet.</p>
        <% end %>
      </div>

      <!-- Comment Form -->
      <div style="margin-top: 15px;">
        <h4>Add a Comment:</h4>
        <%= form_with(model: @new_message, url: messages_path, local: true) do |form| %>
          <%= form.hidden_field :complaint_id, value: complaint.id %>
          <%= form.hidden_field :user_id, value: current_user.id %>
          <p>
            <%= form.text_area :content, placeholder: "Write your comment...", rows: 3, style: "width: 100%; border-radius: 5px;" %><br>
            <%= form.submit "Post Comment", style: "margin-top: 5px; padding: 5px 15px; background: #28a745; color: white; border: none; border-radius: 4px;" %>
          </p>
        <% end %>
      </div>
    </div>
  <% end %>
<% else %>
  <p style="color: #777;">No complaints in this category.</p>
<% end %>
